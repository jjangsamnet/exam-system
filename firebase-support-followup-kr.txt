제목: 후속 조치: 데이터베이스 마이그레이션 실패 - 상세 디버그 정보

---

안녕하세요 Firebase 지원팀,

이전에 제공해주신 가이드를 따라 모든 제안 사항을 시도했으나, 마이그레이션이 여전히 실패합니다. 아래는 시도한 내용과 결과에 대한 상세 보고서입니다.

프로젝트 정보:
- 프로젝트 ID: exam-system-28765
- 서비스 ID: exam-system
- Cloud SQL 인스턴스: exam-system-fdc
- 데이터베이스: fdcdb
- 리전: us-east4
- 내 IP 주소: 210.107.8.68

---

시도한 방법 (가이드 내용 따름):

1. IAM 권한 확인 ✓
   - kd12345@gmail.com 계정의 역할 확인 완료:
     ✓ 소유자 (roles/owner)
     ✓ Cloud SQL 관리자 (roles/cloudsql.admin)
     ✓ Firebase 관리자 (roles/firebase.admin)
   - 필요한 모든 권한 보유

2. 네트워크 구성 ✓
   - Cloud SQL 승인된 네트워크에 내 IP 주소 (210.107.8.68/32) 추가
   - 구성 저장 완료

3. FIREBASE DATACONNECT:SQL:SETUP 명령
   명령어: firebase dataconnect:sql:setup

   결과: 실패
   오류: "An unexpected error has occurred"

   디버그 로그 발췌:
   ```
   [2025-11-20T04:11:06.239Z] >
       DO $$
       DECLARE
           role_count INTEGER;
       BEGIN
           SELECT COUNT(*)
           INTO role_count
           FROM pg_auth_members m
           JOIN pg_roles grantee ON grantee.oid = m.member
           JOIN pg_roles granted ON granted.oid = m.roleid
           JOIN pg_roles grantor ON grantor.oid = m.grantor
           WHERE
             granted.rolname = 'cloudsqlsuperuser'
             AND grantee.rolname = 'firebaseowner_fdcdb_public';

           IF role_count = 0 THEN
               RAISE EXCEPTION 'Role "%", is not granted to role "%".',
                   'cloudsqlsuperuser', 'firebaseowner_fdcdb_public';
           END IF;
       END $$;

   [2025-11-20T04:11:06.469Z] 트랜잭션 롤백 - 오류 발생
   error: Role "cloudsqlsuperuser", is not granted to role "firebaseowner_fdcdb_public".

   [2025-11-20T04:11:12.366Z] Error: Connection terminated due to connection timeout
   ```

   분석:
   - 명령어가 Cloud SQL에 성공적으로 연결됨
   - "firebaseowner_fdcdb_public" 역할에 "cloudsqlsuperuser" 권한이 없음을 감지
   - "firebasesuperuser" 사용자 생성 시도
   - SQL 명령 실행 중 연결 타임아웃 발생

4. FIREBASE DATACONNECT:SQL:MIGRATE --FORCE
   명령어: firebase dataconnect:sql:migrate --force

   결과: 실패
   오류: "An unexpected error has occurred"
   오류 발생 지점: "Granting firebaseowner role to myself kd12345@gmail.com..."

5. FIREBASE DEPLOY --ONLY DATACONNECT
   명령어: firebase deploy --only dataconnect

   결과: 실패
   오류: "Command aborted. Your database schema is incompatible with your Data Connect schema"
   메시지: "Run `firebase dataconnect:sql:migrate` to migrate your database schema"

---

근본 원인 파악:

디버그 로그 분석 결과:

1. Firebase CLI가 Cloud SQL에 인증 및 연결 성공
2. PostgreSQL 역할 권한 누락 감지:
   - "firebaseowner_fdcdb_public" 역할에 "cloudsqlsuperuser" 권한 필요
3. Firebase CLI가 데이터베이스 사용자 및 역할 생성/수정 시도
4. **SQL 명령 실행 중 연결 타임아웃 발생**
5. 마이그레이션 완료 불가

연결 타임아웃의 원인으로 추정되는 사항:
- 로컬 머신과 Cloud SQL(us-east4) 간 네트워크 지연
- 방화벽/프록시 간섭 가능성
- Cloud SQL 연결 풀 고갈

---

필요한 마이그레이션 SQL:

데이터베이스에 실행해야 할 SQL:

```sql
ALTER TABLE "public"."user"
ADD COLUMN "approval_status" character varying(20) NULL,
ADD COLUMN "school_name" character varying(200) NULL;
```

---

현재 임시 해결책:

다음과 같이 임시 해결책을 적용했습니다:
- 애플리케이션이 schoolName 파라미터를 데이터베이스로 전송하지 않도록 수정
- schoolName은 클라이언트 측 상태에만 저장
- 시스템은 현재 배포되어 정상 작동 중: https://exam-system-28765.web.app
- 사용자들은 로그인 및 시스템 사용 가능

이 임시 해결책으로 시스템은 작동하지만, 다음 기능은 사용할 수 없습니다:
- 학생 학교명을 데이터베이스에 저장
- 교사/관리자 승인 시스템 (approval_status 필드 필요)

---

지원 요청:

Firebase 팀에서 다음 옵션 중 하나로 도움을 주실 수 있을까요?

옵션 1: 서버 측 마이그레이션
- Cloud SQL 인스턴스에서 직접 ALTER TABLE 문 실행
- "firebaseowner_fdcdb_public"에 필요한 역할 권한 부여

옵션 2: 연결 타임아웃 조사
- 마이그레이션 중 연결 타임아웃이 발생하는 원인 조사
- 대안적인 연결 방법 제안 (Cloud SQL Proxy 등)
- 타임아웃 제한 증가 방법 안내

옵션 3: 대체 마이그레이션 방법
- Firebase Console을 통한 수동 마이그레이션 단계 제공
- 기존 데이터베이스에 대한 Data Connect 스키마 마이그레이션 관리 문서

---

기술 환경:

- OS: Windows
- Firebase CLI 버전: 최신 (npm을 통해 설치)
- Node.js: 최신 LTS
- 네트워크: 방화벽이 있는 기업 네트워크
- 위치: 대한민국
- 대상 리전: us-east4 (미국)

---

추가 정보:

Firebase CLI 디버그 로그 (전체 출력은 요청 시 제공 가능):
- 인증: 성공
- API 호출: 성공
- Cloud SQL 연결: 성공
- 임시 인증서 생성: 성공
- SQL 명령 실행: 약 10초 후 타임아웃

Cloud SQL 인스턴스 설정:
- 데이터베이스 버전: POSTGRES_15
- 티어: db-f1-micro
- 공개 IP: 35.245.133.94
- IAM 인증: 활성화
- SSL 모드: ALLOW_UNENCRYPTED_AND_ENCRYPTED

---

긴급도:

중간 - 시스템은 현재 임시 해결책으로 작동 중이나, 프로덕션 사용을 위해 승인 시스템과 학교명 기능이 필요합니다.

지속적인 지원에 감사드립니다. 추가 정보나 로그 파일이 필요하시면 알려주세요.

감사합니다.
